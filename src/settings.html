<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Composer - Shell Menu Settings</title>
  <style>
    body {
        width: 90%;
        margin: 30px auto;
        font-family: Helvetica,arial,sans-serif;
        font-size: 15px;
        line-height: 25px;
        color: #333;
    }

    h2 {
        margin: 2em 0 1em;
        line-height: 1.7;
        border-bottom: 1px solid #ddd;
    }
    code {
        font-family: Consolas,Courier,monospace;
        font-size: 12px;
        background-color: #f8f8f8;
        border: 1px solid #f2f2f2;
        border-radius: 4px;
        padding: 0 5px;
        white-space: nowrap;
        display: inline-block;
        line-height: 140%;
    }

    dd.note {
        font-size: 85%;
    }

    dl {
        background-color: #fefefe;
        border: 1px solid #eee;
        border-radius: 6px;
        margin: 20px 2px;
        padding: 10px;
    }

    dt {
        font-weight:bold;
    }

    table {
        border-collapse: separate;
        border-spacing: 15px 10px;
        font-size: 14px;
        border: 1px solid #eee;
        border-radius: 6px;
        background-color: #fefefe;
        width: 100%;
    }

  </style>
</head>
<body>

<h1>Composer - Shell Menu Settings</h1>
<p>
These settings allow you to modify the functionality of the Shell Menus feature. The dialog can be opened from the Control Panel (Programs and Features, Composer, Change) or from the Shell Menus, by clicking <strong>Settings</strong> on the Composer Options sub-menu. The following changes can be made:
</p>

<ul>
<li>Add or Remove the Shell Menus feature</li>
<li>Display the Composer menu in a collapsed state, to save space on the context-menu</li>
<li>Change the default console program that is invoked when you click a menu command</li>
</ul>

<h2>Default Console</h2>
<p>The console program that is used is set on a per-user basis. By default the Shell Menus use the Command Prompt, but other types of console are available, depending on whether they are installed and can be discovered. These are:
</p>
</p>

<ul>
<li>Native Windows: <em>PowerShell</em></li>
<li>Unixy: <em>Cygwin</em>, <em>Git Bash</em> and <em>Msys</em></li>
</ul>

<p>
To use a different console, highlight it and click the <strong>Set Default</strong> button. If one of the consoles listed above is installed but not displayed, you can use it by clicking the <strong>Add</strong> button and browsing to its location. The <a href="#default">Default Settings</a> section may help you identify the correct location and target. Note that all required properties will be added automatically.
</p>

<p>
After you run a Composer command, the console remains open and offers you the option of continuing to work in the selected directory. Git Bash users may see the <em>Welcome to Git</em> message again, depending on their version of Git for Windows. See <a href="#gitbash">Git Bash Notes</a> for information about suppressing this message.
</p>

<h2>Adding a Console</h2>
<p>
You can use another console program but incorporating it requires a little effort. The <a href="#examples">Examples</a> section shows the settings for some popular console programs. Click the <strong>Add</strong> button and browse to the program location. Next you must enter the properties that are required to Open and Run it. A specific pattern-format is used to enable the run-time replacement of required values, comprising the following modifiers:
</p>

<dl>
<dt>[d] directory</dt>
<dd>
Indicates that the console program can be opened in the selected directory. Not a positional parameter.
</dd>

<dt>{s} script</dt>
<dd>
Positional script parameter - will be replaced by the shim script, <em>composer-shell</em>. Requires <code>"{d}"</code> and <code>{a}</code>  modifiers to follow it.
</dd>

<dt>"{d}" directory</dt>
<dd>
Positional directory parameter - will be replaced by the selected directory. This must always be double-quoted. Your console may need these double-quotes to be escaped, which is normally done using the <code>\"{d}\"</code> pattern.
</dd>

<dt>{a} arguments</dt>
<dd>
Positional arguments parameter - will be replaced by the Composer command params.
</dd>

</dl>

<p>
The Shell Menus will use your console in two ways, either opening it in the selected directory or running a Composer command in the selected directory, so you must provide properties for these Open and Run events. A shim script is needed in the following situations:
</p>

<ul>
<li>if the console cannot be started in a specified directory</li>
<li>if the console automatically closes at the end of the script</li>
<li>if the commands are run elevated</li>
</ul>

<p>When you incorporate the shim script, you must always follow it with <code>"{d}" {a}</code> modifiers, because the script requires these parameters. In the following explanatory examples the selected directory is <em>C:\Users\Name</em>.
</p>

<dl>

<dt><strong>Open</strong></dt>
<dd>
If the program can be started in a directory, we can just append <code>[d]</code> to any other parameters, otherwise the shim script must be used: <code>... {s} "{d}" {a}</code>
</dd>
<dd>
At runtime this results in: <code>... composer-shell "C:/Users/Name" --open--</code>
</dd>
<dd class="note">
Note that the special <em>--open--</em> argument is automatically added. This tells the shim script to open the console rather than run a command.
</dd>

<br>
<dt><strong>Run</strong></dt>
<dd>
All consoles must use the shim script, in case they need to be elevated: <code>... {s} "{d}" {a}</code>.
</dd>
<dd>
Assuming we are calling <em>composer install</em>, at runtime this results in <code>... composer-shell "C:/Users/Name" install</code>
</dd>
</dl>

<p>
It is recommended that you test your properties by clicking the <strong>Open</strong> and <strong>Run</strong> buttons. Only one non-default program can be added and it will be named Custom.
</p>

<a name="examples"></a>
<h2>Examples</h2>
<p>
The following examples show how to integrate popular console programs.
</p>


<table>
<col width="160" />

<!-- ConEmu -->
<tr>
<td><strong>ConEmu</strong></td>
<td>
Uses the same command for both events. This shows how to open Git Bash, assuming it is installed in Program Files.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;path&gt;\ConEmu.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>/cmd "C:\Program Files\Git\bin\sh.exe" --login -i {s} "{d}" {a}</code></td>
</tr>
<tr>
<td>Run</td><td><code>/cmd "C:\Program Files\Git\bin\sh.exe" --login -i {s} "{d}" {a}</code></td>
</tr>

<tr><td colspan="2">&nbsp;</td></tr>

<!-- Console2 -->
<tr>
<td><strong>Console2</strong></td>
<td>
Requires that you have an existing tab that starts your chosen console. Any start-up directory information in the tab is ignored.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;path&gt;\console.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>-t MyTab -d "{d}"</code></td>
</tr>
<tr>
<td>Run</td><td><code>-t MyTab -r "{s} \"{d}\" {a}"</code></td>
</tr>

<tr><td colspan="2">&nbsp;</td></tr>

<!-- Take Command -->
<tr>
<td><strong>Take Command</strong></td>
<td>
Uses the same command for both events. If you incorporate other switches, make sure /k... is at the end.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;path&gt;\tcc.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>/k {s} "{d}" {a}</code></td>
</tr>
<tr>
<td>Run</td><td><code>/k {s} "{d}" {a}</code></td>
</tr>

</table>

<p>
If you have integrated a different console program, please share the settings on <a href="https://github.com/johnstevenson/composer-setup/issues">Github</a> so they can be included in this documentation.
</p>


<a name="default"></a>
<h2>Default Settings</h2>
<p>
These settings are used for installed consoles, showing the expected locations, target file names and properties.
</p>


<table>
<col width="160" />

<!-- Command Prompt -->
<tr>
<td><strong>Command Prompt</strong></td>
<td>
Starts in the selected directory.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;System32&gt;\cmd.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>/k [d]</code></td>
</tr>
<tr>
<td>Run</td><td><code>/k {s} "{d}" {a}</code></td>
</tr>

<tr><td colspan="2">&nbsp;</td></tr>

<!-- Cygwin -->
<tr>
<td><strong>Cygwin</strong></td>
<td>
Needs the shim script for both events.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;path&gt;\cygwin\bin\bash.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>--login -i {s} "{d}" {a}</code></td>
</tr>
<tr>
<td>Run</td><td><code>--login -i {s} "{d}" {a}</code></td>
</tr>

<tr><td colspan="2">&nbsp;</td></tr>

<!-- Git Bash -->
<tr>
<td><strong>Git Bash</strong></td>
<td>
Starts in the selected directory.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;path&gt;\Git\bin\sh.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>--login -i [d]</code></td>
</tr>
<tr>
<td>Run</td><td><code>--login -i {s} "{d}" {a}</code></td>
</tr>

<tr><td colspan="2">&nbsp;</td></tr>

<!-- Msys -->
<tr>
<td><strong>Msys</strong></td>
<td>
Needs the shim script for both events.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;path&gt;\msys\*\bin\sh.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>--login -i {s} "{d}" {a}</code></td>
</tr>
<tr>
<td>Run</td><td><code>--login -i {s} "{d}" {a}</code></td>
</tr>

<tr><td colspan="2">&nbsp;</td></tr>

<!-- PowerShell -->
<tr>
<td><strong>PowerShell</strong></td>
<td>
Starts in the selected directory.
</td>
</tr>
<tr>
<td>Program</td><td><code>&lt;System32&gt;\WindowsPowerShell\*\powershell.exe</code></td>
</tr>
<tr>
<td>Open</td><td><code>[d]</code></td>
</tr>
<tr>
<td>Run</td><td><code>-executionpolicy bypass -Command {s} \"{d}\" {a}</code></td>
</tr>

</table>


<a name="gitbash"></a>
<h2>Git Bash Notes</h2>
<p>
You can suppress the additional <em>Welcome to Git</em> message by either upgrading Git for Windows to a version later than <code>1.8.5.2</code> or changing a line in the <code>profile</code> file as illustrated below. Note that if this file is in a protected location, you will need to be running as an admin to make this change.
</p>

<table>
<col width="160" />

<tr>
<td>File</td>
<td>
<code>&lt;path&gt;\Git\etc\profile</code>
</td>
</tr>

<tr>
<td>Find line</td>
<td>
<code>test -f /etc/motd && sed "s/\$MESSAGE/$MESSAGE/" < /etc/motd</code>
</td>
</tr>

<tr>
<td>Replace with</td>
<td>
<code>test -z "$SKIP_MOTD" && test -f /etc/motd && sed "s/\$MESSAGE/$MESSAGE/" < /etc/motd</code>
</td>
</tr>

</table>

</body>
</html>
